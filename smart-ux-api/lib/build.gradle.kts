/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java library project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.10.2/userguide/building_java_projects.html in the Gradle documentation.
 */

plugins {
    // Apply the java-library plugin for API and implementation separation.
    `java-library`
}

group = "com.smartuxapi.ai"  // ê·¸ë£¹ ID ì„¤ì •
version = "0.6.1"            // í”„ë¡œì íŠ¸ ë²„ì „ ì„¤ì •

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Use JUnit Jupiter test framework.
    testImplementation("org.junit.jupiter:junit-jupiter:5.10.1")
    
    // JUnit Platform Suite API (í†µí•© í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ìš©)
    testImplementation("org.junit.platform:junit-platform-suite-api:1.10.1")
    testRuntimeOnly("org.junit.platform:junit-platform-suite-engine:1.10.1")

    // This dependency is exported to consumers, that is to say found on their compile classpath.
    api("org.apache.commons:commons-math3:3.6.1")

    // This dependency is used internally, and not exposed to consumers on their own compile classpath.
    implementation("com.google.guava:guava:33.2.1-jre")
    
    implementation("jakarta.servlet:jakarta.servlet-api:5.0.0")
    
    implementation("com.fasterxml.jackson.core:jackson-databind:2.15.3")
    implementation("com.fasterxml.jackson.core:jackson-core:2.15.3")
    implementation("com.fasterxml.jackson.core:jackson-annotations:2.15.3")
    
    implementation("com.googlecode.json-simple:json-simple:1.1.1")
    implementation("org.json:json:20250517")
    
    implementation("org.apache.logging.log4j:log4j-api:2.21.0")   // Log4j API
    implementation("org.apache.logging.log4j:log4j-core:2.21.0")  // Log4j Core
    
    // SnakeYAML (YAML íŒŒì¼ íŒŒì‹±ìš©)
    implementation("org.yaml:snakeyaml:2.2")
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

tasks.jar {
    archiveFileName.set("${rootProject.name}-${project.version}.jar")
    
    manifest {
        attributes(
            "Implementation-Title" to project.name,
            "Implementation-Version" to project.version,
            "Implementation-Vendor" to "Smart UX API",
            "Built-By" to System.getProperty("user.name"),
            "Built-JDK" to System.getProperty("java.version"),
            "Created-By" to "Gradle ${gradle.gradleVersion}"
        )
    }
}

// JavaDoc ì„¤ì •
tasks.javadoc {
    options {
        this as StandardJavadocDocletOptions
        encoding = "UTF-8"
        charset("UTF-8")
        docEncoding = "UTF-8"
        
        // JavaDoc ì˜µì…˜
        memberLevel = JavadocMemberLevel.PROTECTED
        links("https://docs.oracle.com/en/java/javase/17/docs/api/")
        
        // ê²½ê³  ë¬´ì‹œ (í•„ìš”í•œ ê²½ìš°)
        addStringOption("Xdoclint:none", "-quiet")
        
        // ì»¤ìŠ¤í…€ íƒœê·¸
        tags(
            "apiNote:a:API Note:",
            "implSpec:a:Implementation Requirements:",
            "implNote:a:Implementation Note:"
        )
        
        // HTML5 ì¶œë ¥
        addBooleanOption("html5", true)
        
        // ìœˆë„ìš° ì œëª©
        windowTitle = "Smart UX API ${project.version} API Documentation"
        
        // ë¬¸ì„œ ì œëª©
        docTitle = "Smart UX API ${project.version}"

        // í•˜ë‹¨ í…ìŠ¤íŠ¸ - addStringOptionìœ¼ë¡œ ì„¤ì •
        addStringOption("bottom", "<div style='text-align: center;'>Copyright 2025 <a href='https://jiniebox.com'>jiniebox.com</a>. Licensed under the <a href='https://www.apache.org/licenses/LICENSE-2.0'>Apache License 2.0</a>.<br>Contact: <a href='mailto:kiunsea@gmail.com'>kiunsea@gmail.com</a> | Website: <a href='https://www.omnibuscode.com'>www.omnibuscode.com</a></div>")

        // í—¤ë” - addStringOptionìœ¼ë¡œ ì„¤ì •
        addStringOption("header", "<b>Smart UX API ${project.version}</b><br><span style='font-size: 90%;'>AI-powered UI Automation</span>")
    }
    
    // ì†ŒìŠ¤ íŒŒì¼ í¬í•¨
    source = sourceSets["main"].allJava
    
    // í´ë˜ìŠ¤íŒ¨ìŠ¤ ì„¤ì •
    classpath = configurations["compileClasspath"]
}

// JavaDoc JAR ìƒì„±
tasks.register<Jar>("javadocJar") {
    group = "documentation"
    description = "Assembles a jar archive containing the JavaDoc."
    archiveClassifier.set("javadoc")
    from(tasks.javadoc)
}

// Sources JAR ìƒì„±
tasks.register<Jar>("sourcesJar") {
    group = "documentation"
    description = "Assembles a jar archive containing the main sources."
    archiveClassifier.set("sources")
    from(sourceSets["main"].allSource)
}

// Build ì‹œ JavaDocê³¼ Sources JAR ìƒì„±
tasks.build {
    dependsOn("javadocJar", "sourcesJar")
}

// Test ë¦¬í¬íŠ¸ ì„¤ì •
tasks.test {
    useJUnitPlatform()
    
    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸
    reports {
        html.required.set(true)
        junitXml.required.set(true)
    }
    
    // í…ŒìŠ¤íŠ¸ ë¡œê¹…
    testLogging {
        events("passed", "skipped", "failed")
        exceptionFormat = org.gradle.api.tasks.testing.logging.TestExceptionFormat.FULL
        showStandardStreams = true // í…ŒìŠ¤íŠ¸ ì¶œë ¥ í‘œì‹œ
        showExceptions = true
        showCauses = true
        showStackTraces = true
        minGranularity = 0 // í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„ í‘œì‹œ
    }
    
    // í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì† ì‹¤í–‰
    ignoreFailures = false
    
    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ì¶œë ¥
    addTestListener(object : org.gradle.api.tasks.testing.TestListener {
        override fun beforeSuite(suite: org.gradle.api.tasks.testing.TestDescriptor) {}
        override fun afterSuite(suite: org.gradle.api.tasks.testing.TestDescriptor, result: org.gradle.api.tasks.testing.TestResult) {
            if (suite.parent == null) {
                println("\n" + "=".repeat(80))
                println("í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½")
                println("=".repeat(80))
                println("ì´ í…ŒìŠ¤íŠ¸: ${result.testCount}")
                println("ì„±ê³µ: ${result.successfulTestCount}")
                println("ì‹¤íŒ¨: ${result.failedTestCount}")
                println("ê±´ë„ˆëœ€: ${result.skippedTestCount}")
                println("ì‹¤í–‰ ì‹œê°„: ${result.endTime - result.startTime}ms")
                println("=".repeat(80))
                println("ìƒì„¸ ë¦¬í¬íŠ¸: build/reports/tests/test/index.html")
                println("=".repeat(80) + "\n")
            }
        }
        override fun beforeTest(testDescriptor: org.gradle.api.tasks.testing.TestDescriptor) {}
        override fun afterTest(testDescriptor: org.gradle.api.tasks.testing.TestDescriptor, result: org.gradle.api.tasks.testing.TestResult) {}
    })
}

// ============================================================
// deploy íƒœìŠ¤í¬: JAR ë¹Œë“œ ë° ë°°í¬
// ============================================================

tasks.register("deploy") {
    group = "distribution"
    description = "JARë¥¼ ë¹Œë“œí•˜ê³  doriboxì™€ smuxapi-demoì— ë°°í¬í•©ë‹ˆë‹¤."
    
    dependsOn("jar")
    
    // ë°°í¬ ëŒ€ìƒ ë””ë ‰í„°ë¦¬ (lib ëª¨ë“ˆ ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œ)
    val doriboxLibsDir = file("../../../doribox/libs")
    
    doFirst {
        println("=".repeat(60))
        println("ğŸš€ smart-ux-api ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘")
        println("=".repeat(60))
        println("ë°°í¬ ëŒ€ìƒ:")
        println("  - doribox: ${doriboxLibsDir.absolutePath}")
        println()
    }
    
    doLast {
        val jarTask = tasks.named<Jar>("jar").get()
        val jarFile = jarTask.archiveFile.get().asFile
        
        if (!jarFile.exists()) {
            throw GradleException("JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${jarFile.absolutePath}")
        }
        
        println("[1/4] ë¹Œë“œëœ JAR íŒŒì¼ í™•ì¸")
        println("   -> ${jarFile.name} (${String.format("%.2f", jarFile.length() / 1024.0 / 1024.0)} MB)")
        println()
        
        // 3. doribox libsì—ì„œ ì´ì „ ë²„ì „ JAR ì‚­ì œ
        println("[2/4] doribox libsì—ì„œ ì´ì „ ë²„ì „ JAR ì‚­ì œ ì¤‘...")
        if (doriboxLibsDir.exists()) {
            val deletedCount = doriboxLibsDir.listFiles { file ->
                file.isFile && file.name.startsWith("smart-ux-api-") && file.name.endsWith(".jar")
            }?.count { oldJar ->
                println("   -> ì‚­ì œ: ${oldJar.name}")
                oldJar.delete()
            } ?: 0
            if (deletedCount == 0) {
                println("   -> ì‚­ì œí•  ì´ì „ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤.")
            }
        } else {
            println("   -> ê²½ê³ : doribox libs ë””ë ‰í„°ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: ${doriboxLibsDir.absolutePath}")
            println("      (ë””ë ‰í„°ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤)")
            doriboxLibsDir.mkdirs()
        }
        println()
        
        // 4. ìµœì‹  JAR ë³µì‚¬
        println("[4/4] ìµœì‹  JAR ë³µì‚¬ ì¤‘...")
              
        // doriboxì— ë³µì‚¬
        val targetDoriboxJar = file("${doriboxLibsDir.absolutePath}/${jarFile.name}")
        jarFile.copyTo(targetDoriboxJar, overwrite = true)
        println("   -> doribox: ${targetDoriboxJar.absolutePath}")
        
        println()
        println("=".repeat(60))
        println("âœ… ë°°í¬ ì™„ë£Œ!")
        println("=".repeat(60))
        println()
        println("ğŸ“¦ ë°°í¬ëœ JAR íŒŒì¼:")
        println("   ì´ë¦„: ${jarFile.name}")
        println("   í¬ê¸°: ${String.format("%.2f", jarFile.length() / 1024.0 / 1024.0)} MB")
        println()
        println("ğŸ“‚ ë°°í¬ ìœ„ì¹˜:")
        println("   - doribox: ${targetDoriboxJar.absolutePath}")
        println()
        println("=".repeat(60))
    }
}